<div class="container">
  <header class="header">
    <div class="header-title">
      <a routerLink="/menu" class="btn-volver" title="Volver al men√∫">
        ‚Üê
      </a>
      <h1>{{ selectedCategoria() ? selectedCategoria() : 'Equipos' }}</h1>
    </div>
    <div class="header-actions">
      @if (selectedCategoria()) {
        <button class="btn btn-secondary" (click)="clearCategoria(); router.navigate(['/equipos']);">
          ‚Üê Ver todas las categor√≠as
        </button>
      }
      <button class="btn btn-filter" (click)="toggleFilters()">
        üîç Filtros
      </button>
      <a [routerLink]="['/equipos', 'nuevo']" [queryParams]="{ categoria: selectedCategoria() }" class="btn btn-primary" [class.disabled]="!selectedCategoria()">
        + Agregar
      </a>
    </div>
  </header>

  <!-- Men√∫ de Categor√≠as (cuando no hay categor√≠a seleccionada) -->
  @if (!selectedCategoria()) {
    <div class="categorias-grid">
      @for (cat of categorias; track cat) {
        <div class="categoria-card" (click)="selectCategoria(cat)">
          @if (getCategoriaIcon(cat).endsWith('.png') || getCategoriaIcon(cat).endsWith('.jpg') || getCategoriaIcon(cat).endsWith('.svg')) {
            <img [src]="'icons/' + getCategoriaIcon(cat)" [alt]="cat" class="categoria-img">
          } @else {
            <div class="categoria-icon">{{ getCategoriaIcon(cat) }}</div>
          }
          <div class="categoria-nombre">{{ cat }}</div>
          <div class="categoria-count">{{ equiposPorCategoria()[cat] || 0 }} equipos</div>
        </div>
      }
    </div>
  }

  <!-- Men√∫ Flotante de Filtros -->
  @if (showFilters() && selectedCategoria()) {
    <div class="filter-panel">
      <div class="filter-header">
        <h3>Filtros</h3>
        <button class="btn btn-sm btn-secondary" (click)="clearFilters()">
          Limpiar
        </button>
      </div>
      <div class="filter-content">
        <div class="filter-group">
          <label for="filter-search">Buscar</label>
          <input
            type="text"
            id="filter-search"
            [(ngModel)]="filterSearch"
            placeholder="Nombre, marca, modelo..."
            class="form-control"
          />
        </div>
        <div class="filter-group">
          <label for="filter-piso">Piso</label>
          <select id="filter-piso" [(ngModel)]="filterPiso" class="form-control">
            <option value="">Todos los pisos</option>
            @for (piso of pisos; track piso) {
              <option [value]="piso">{{ piso }}</option>
            }
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-estado">Estado</label>
          <select id="filter-estado" [(ngModel)]="filterEstado" class="form-control">
            <option value="">Todos los estados</option>
            @for (estado of estados; track estado) {
              <option [value]="estado">{{ estado }}</option>
            }
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-ambiente">Ambiente</label>
          <select id="filter-ambiente" [(ngModel)]="filterAmbiente" class="form-control">
            <option value="">Todos los ambientes</option>
            @for (amb of ambientes(); track amb) {
              <option [value]="amb">{{ amb }}</option>
            }
          </select>
        </div>
      </div>
    </div>
  }

  @if (loading()) {
    <div class="loading">Cargando equipos...</div>
  }

  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  @if (!loading() && !error()) {
    <!-- Resumen de filtros activos -->
    @if ((filterPiso() || filterEstado() || filterAmbiente() || filterSearch()) && selectedCategoria()) {
      <div class="filter-summary">
        <span>Filtros activos:</span>
        @if (filterPiso()) { <span class="filter-tag">Piso: {{ filterPiso() }}</span> }
        @if (filterEstado()) { <span class="filter-tag">Estado: {{ filterEstado() }}</span> }
        @if (filterAmbiente()) { <span class="filter-tag">Ambiente: {{ filterAmbiente() }}</span> }
        @if (filterSearch()) { <span class="filter-tag">Busqueda: {{ filterSearch() }}</span> }
      </div>
    }

    <!-- Vista de tabla para desktop (solo si hay categor√≠a seleccionada) -->
    @if (selectedCategoria()) {
      <div class="table-container desktop-only">
        <table class="table">
          <thead>
            <tr>
              <th class="sortable" (click)="setSortField('nombre')">
                Nombre {{ getSortIcon('nombre') }}
              </th>
              <th>Piso</th>
              <th>Descripci√≥n</th>
              <th class="sortable" (click)="setSortField('marca')">
                Marca {{ getSortIcon('marca') }}
              </th>
              <th class="sortable" (click)="setSortField('modelo')">
                Modelo {{ getSortIcon('modelo') }}
              </th>
              <th>Estado</th>
              <th class="sortable" (click)="setSortField('ambientecodigo')">
                Ambiente {{ getSortIcon('ambientecodigo') }}
              </th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (equipo of equiposPaginados(); track equipo.id) {
              <tr>
                <td>{{ equipo.nombre }}</td>
                <td>{{ equipo.piso || '-' }}</td>
                <td>{{ equipo.descripcion || '-' }}</td>
                <td>{{ equipo.marca }}</td>
                <td>{{ equipo.modelo }}</td>
                <td>{{ equipo.estado }}</td>
                <td>{{ equipo.ambientecodigo || 'Sin asignar' }}</td>
                <td class="actions">
                  <a [routerLink]="['/equipos', equipo.id]" class="btn btn-sm btn-edit">
                    Editar
                  </a>
                  <button (click)="deleteEquipo(equipo.id!)" class="btn btn-sm btn-delete">
                    Eliminar
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="8" class="empty">No hay equipos en esta categor√≠a</td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Controles de paginaci√≥n (ESCRITORIO) -->
        @if (totalPages() > 1) {
          <div class="pagination">
            <button
              class="btn btn-sm btn-secondary"
              [disabled]="currentPage() === 1"
              (click)="prevPage()">
              ‚Üê Anterior
            </button>
            <span class="pagination-info">
              {{ equiposFiltradosOrdenados().length }} equipos - P√°gina {{ currentPage() }} de {{ totalPages() }}
            </span>
            <button
              class="btn btn-sm btn-secondary"
              [disabled]="currentPage() === totalPages()"
              (click)="nextPage()">
              Siguiente ‚Üí
            </button>
          </div>
        }
      </div>

      <!-- Vista de tarjetas para mobile -->
      <div class="cards-container mobile-only">
        @for (equipo of equiposFiltradosOrdenados(); track equipo.id) {
          <div class="card">
            <div class="card-header">
              <span class="card-nombre">{{ equipo.nombre }}</span>
              <span class="card-estado" [class]="equipo.estado?.toLowerCase()">{{ equipo.estado }}</span>
            </div>
            <div class="card-body" [routerLink]="['/equipos', equipo.id]">
              @if (equipo.piso) {
                <p class="card-piso">üè¢ Piso: {{ equipo.piso }}</p>
              }
              @if (equipo.descripcion) {
                <p class="card-descripcion">{{ equipo.descripcion }}</p>
              }
              <p class="card-marca">{{ equipo.marca }} - {{ equipo.modelo }}</p>
              <p class="card-ambiente" *ngIf="equipo.ambientecodigo">
                üìç {{ equipo.ambientecodigo }}
              </p>
            </div>
            <div class="card-actions">
              <a [routerLink]="['/equipos', equipo.id]" class="btn btn-sm btn-edit">
                Editar
              </a>
              <button (click)="deleteEquipo(equipo.id!)" class="btn btn-sm btn-delete">
                Eliminar
              </button>
            </div>
          </div>
        } @empty {
          <div class="empty-card">No hay equipos en esta categor√≠a</div>
        }
      </div>
    }
  }
</div>
